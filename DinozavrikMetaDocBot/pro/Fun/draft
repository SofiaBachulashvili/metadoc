from telebot.async_telebot import AsyncTeleBot
import os

# –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
bot = AsyncTeleBot('token')
SAVE_FOLDER = 'Pro/Fun/CompareFILES/saveF/'

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞–ø–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if not os.path.exists(SAVE_FOLDER):
    os.makedirs(SAVE_FOLDER)

# –°–ø–∏—Å–æ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
user_files = []

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–æ–º–∞–Ω–¥ /start, /Hello, /Hola
@bot.message_handler(commands=['start', 'Hello', 'Hola'])
async def start_command(message):
    await bot.send_message(message.chat.id,
                           f"Hola, {message.from_user.first_name}!\nI am dinozavrik Metadoc\nLet's be friends.üå∏\nI am learning to work with files.")

@bot.message_handler(commands=['help'])  # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É /help
async def help_command(message):
    commands_list = [
        '/start - –ù–∞—á–∞–ª–æ –æ–±—â–µ–Ω–∏—è —Å –±–æ—Ç–æ–º',
        '/help - –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥',
        '/save_file_for_work - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏'
    ]
    commands_text = "<u>Available Commands:</u>\n" + "\n".join(commands_list)
    await bot.send_message(message.chat.id, commands_text, parse_mode='html')

@bot.message_handler(content_types=['document'])  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
async def handle_file(message):
    user_files.append(message.document.file_id)  # –°–æ—Ö—Ä–∞–Ω—è–µ–º file_id

    await bot.send_message(message.chat.id, "–§–∞–π–ª –ø—Ä–∏–Ω—è—Ç! –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É /save_file_for_work –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.")

@bot.message_handler(commands=['save_file_for_work'])  # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /save_file_for_work
async def save_files_command(message):
    for file_id in user_files:
        file_info = await bot.get_file(file_id)
        file_path = file_info.file_path

        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
        downloaded_file = await bot.download_file(file_path)

        # –ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
        file_name = file_info.file_path.split('/')[-1]  # –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ –ø—É—Ç–∏
        file_save_path = os.path.join(SAVE_FOLDER, file_name)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
        with open(file_save_path, 'wb') as new_file:
            new_file.write(downloaded_file)

    user_files.clear()  # –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    await bot.send_message(message.chat.id, "–§–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! üéâ")

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
if __name__ == '__main__':
    import asyncio
    asyncio.run(bot.polling())









"""
import os
import telebot
from Beginnig import bot  # –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç bota


# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ–∞–π–ª –¥–æ–ø—É—Å—Ç–∏–º—ã–º
def is_valid_file_extension(file_name):
    valid_extensions = (
        '.txt', '.doc', '.pdf',  # —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
        '.jpeg', '.jpg', '.png', '.gif',  # –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
        '.mp3', '.wav', '.ogg',  # –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã
        '.avi', '.mp4', '.mkv',  # –≤–∏–¥–µ–æ —Ñ–∞–π–ª—ã
        '.exe', '.jar', '.dll'  # –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã
    )
    return file_name.lower().endswith(valid_extensions)


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
@bot.message_handler(content_types=['document'])
def handle_document(message):
    # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    doc_info = message.document
    file_name = doc_info.file_name

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∞–ª–∏–¥–Ω–æ–µ –ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
    if not is_valid_file_extension(file_name):
        bot.send_message(message.chat.id,
                         "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–∞–π–ª. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π, –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π, –∞—É–¥–∏–æ, –≤–∏–¥–µ–æ –∏–ª–∏ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª.")
        return

    # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    file_path = bot.get_file(doc_info.file_id)
    downloaded_file = bot.download_file(file_path.file_path)

    # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º —Ñ–∞–π–ª (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –Ω–∞ —Å–≤–æ—é)
    new_file_name = f"renamed_{file_name}"  # –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
    with open(new_file_name, 'wb') as new_file:
        new_file.write(downloaded_file)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
    with open(new_file_name, 'rb') as new_file:
        bot.send_document(message.chat.id, new_file)

    # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞
    os.remove(new_file_name)


# –°–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å —Å –¥–æ–ø—É—Å—Ç–∏–º—ã–º–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏
ALLOWED_EXTENSIONS = {
    'text': ['txt', 'doc', 'pdf'],
    'image': ['jpeg', 'png', 'gif'],
    'audio': ['mp3', 'wav', 'ogg'],
    'video': ['avi', 'mp4', 'mkv'],
    'executable': ['exe', 'jar', 'dll'],
}


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–∞
def get_file_extension(filename):
    return filename.rsplit('.', 1)[-1].lower() if '.' in filename else None


@bot.message_handler(content_types=['document'])  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
def handle_document(message):
    # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª
    file_info = bot.get_file(message.document.file_id)

    # –ò–º—è —Å–æ—Ö—Ä–∞–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
    original_filename = message.document.file_name
    extension = get_file_extension(original_filename)

    if extension in [ext for exts in ALLOWED_EXTENSIONS.values() for ext in exts]:
        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º —Ñ–∞–π–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "renamed_")
        new_filename = f"renamed_{original_filename}"

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
        downloaded_file = bot.download_file(file_info.file_path)

        with open(new_filename, 'wb') as new_file:
            new_file.write(downloaded_file)

        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
        bot.send_message(message.chat.id, f"–§–∞–π–ª '{original_filename}' —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ '{new_filename}'!")
    else:
        # –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
        bot.send_message(message.chat.id, "–ò–∑–≤–∏–Ω–∏—Ç–µ, —ç—Ç–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.")


##############################################################################################################
# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ë–ï–ó–û–ü–ê–°–ù–û–ì–û –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
def handle_document(bot, message):
    # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª
    file_info = bot.get_file(message.document.file_id)

    # –ó–∞–¥–∞–µ–º –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–∏
    save_dir = 'downloads'  # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è, –∫—É–¥–∞ –±—É–¥–µ–º —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ñ–∞–π–ª—ã
    os.makedirs(save_dir, exist_ok=True)  # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

    # –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
    original_file_name = message.document.file_name

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ (–¥–æ–±–∞–≤–ª—è—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    new_file_name = f"{message.from_user.id}_{original_file_name}"

    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –¥–æ 255 —Å–∏–º–≤–æ–ª–æ–≤
    new_file_name = new_file_name[:255]

    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å
    save_path = os.path.join(save_dir, new_file_name)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
    safe_extensions = ('.txt', '.doc', '.pdf', '.jpeg', '.png', '.gif',
                       '.mp3', '.wav', '.ogg', '.avi', '.mp4', '.mkv',
                       '.exe', '.jar', '.dll')
    if not any(new_file_name.endswith(ext) for ext in safe_extensions):
        bot.send_message(message.chat.id, "–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∂–∞–π—Ç–µ —Ñ–∞–π–ª—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–º–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏.")
        return
##############################################################################################################

    # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    downloaded_file = bot.download_file(file_info.file_path)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –ø–æ–¥ –Ω–æ–≤—ã–º –∏–º–µ–Ω–µ–º
    with open(save_path, 'wb') as new_file:
        new_file.write(downloaded_file)

    # –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ —Ñ–∞–π–ª –±—ã–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω
    bot.send_message(message.chat.id, f'–§–∞–π–ª "{original_file_name}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ "{new_file_name}" –≤ –ø–∞–ø–∫–µ "{save_dir}".')
"""









"""


######################################

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ–∞–π–ª –¥–æ–ø—É—Å—Ç–∏–º—ã–º
async def is_valid_file_extension(file_name):
    valid_extensions = (
        '.txt', '.doc', '.pdf',  # —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
        '.jpeg', '.jpg', '.png', '.gif',  # –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
        '.mp3', '.wav', '.ogg',  # –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã
        '.avi', '.mp4', '.mkv',  # –≤–∏–¥–µ–æ —Ñ–∞–π–ª—ã
        '.exe', '.jar', '.dll'  # –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã
    )
    return file_name.lower().endswith(valid_extensions)



# –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
@bot.message_handler(content_types=['/handle_document'])
def handle_document(message):
    # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    bot.send_message(message.chat.id,
                     "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª.")
    doc_info = message.document
    file_name = doc_info.file_name

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∞–ª–∏–¥–Ω–æ–µ –ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
    if not is_valid_file_extension(file_name):
        bot.send_message(message.chat.id,
                         "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–∞–π–ª. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π, –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π, –∞—É–¥–∏–æ, –≤–∏–¥–µ–æ –∏–ª–∏ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª.")
        return

    # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    file_path = bot.get_file(doc_info.file_id)
    downloaded_file = bot.download_file(file_path.file_path)

    # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º —Ñ–∞–π–ª (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –Ω–∞ —Å–≤–æ—é)
    new_file_name = f"renamed_{file_name}"  # –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
    with open(new_file_name, 'wb') as new_file:
        new_file.write(downloaded_file)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
    with open(new_file_name, 'rb') as new_file:
        bot.send_document(message.chat.id, new_file)

    # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞
    os.remove(new_file_name)

"""